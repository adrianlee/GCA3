<script type="text/javascript" src="lib/caat.js"></script>
<script type="text/javascript" src="mixin.js"></script>


<script type="text/javascript" src="lib/box2d.js"></script>
<script type="text/javascript" src="lib/caat-box2d.js"></script>
<script type="text/javascript" src="enemies.js"></script>
<script type="text/javascript" src="powerup.js"></script>
<script type="text/javascript" src="level.js"></script>
<script type="text/javascript" src="player.js"></script>
<div class="sample" id="div_canvas"></div>

<style type="text/css">
    body {
        background: #333;
    }
</style>

<div id="experiment-holder">
    <canvas id="experiment-canvas"></canvas>
</div>

<!-- Preload audio assets into DOM -->
<audio src='sound/1.mp3' preload='auto' id='audio_1'></audio>
<audio src='sound/2.mp3' preload='auto' id='audio_2'></audio>
<audio src='sound/3.mp3' preload='auto' id='audio_3'></audio>
<audio src='sound/music.mp3' preload='auto' id='music_1'></audio>

<img src='Image/Units/BadGuy.png' preload='auto' id='sprite_1'></img>
<img src='Image/Projectiles/Random_Projectile2.png' preload='auto' id='sprite_1'></img>

<script>
    (function() {
        CAAT.DEBUG = 1;

        window.addEventListener('load', __preload, false);

        window.enemy = [];
        window.powerup = [];

        var enemyContainer;
        var powerUpContainer;

        var keys = [0,0,0,0];
        var prevTime = -1;
        var pixelsPerSecond = 400;
        var collision = null;
        var hero = null;
        var world;
        var wallThickness = 5;

        var level=1;
        var joystickE = true;

        var joystickSize = 150;
        var levelpause = false;

        if (joystickE) {
            var joystick = new CAAT.ActorContainer().
                setBounds(30,30,joystickSize,joystickSize).
                setAlpha(0.32).
                setFillStyle('#00ffff').
                cacheAsBitmap();

            var subjsSize = joystickSize/5;
            var subjs = new CAAT.Actor().
                //setShape( CAAT.ShapeActor.prototype.SHAPE_CIRCLE ).
                setBounds(joystickSize/2-subjsSize/2,joystickSize/2-subjsSize/2,subjsSize,subjsSize).
                setFillStyle('#ffff00').
                cacheAsBitmap().
                setSize(40, 40).
                setScale(0.7, 0.7);

            joystick.addChild(subjs);

            joystick.mouseMove = function(e){
                var child = this.childrenList[0];
                    e.point.x < subjsSize-5 ? e.point.x = subjsSize-5 : e.point.x;
                    e.point.x > joystickSize-subjsSize+5 ? e.point.x = joystickSize-subjsSize+5 : e.point.x;
                    e.point.y < subjsSize-5 ? e.point.y = subjsSize-5 : e.point.y;
                    e.point.y > joystickSize-subjsSize+5 ? e.point.y = joystickSize-subjsSize+5 : e.point.y;

                    child.setLocation(e.point.x - child.width/2, e.point.y - child.height/2);
                    // child.moveTo(e.point.x - child.width/2, e.point.y - child.height/2, 5);

                    this.joy_x = e.point.x - this.width/2;
                    this.joy_y = e.point.y - this.height/2;
                };

            joystick.mouseExit = function(e){
                if((e.point.x<0 || e.point.x>joystickSize) ||(e.point.y<0 ||e.point.y>joystickSize) ){
                    this.joy_x = 0;
                    this.joy_y = 0;
                    var child = this.childrenList[0];
                    child.setLocation(this.width/2-child.width/2,this.height/2-child.height/2);
                }
            }
        }

        function __preload() {
            new CAAT.ImagePreloader().loadImages(
                [
                    { id:'bomb', url:'Image/Powerups/bomb.png'},
                    { id:'mushroom', url:'Image/powerups/Mushroom.png'},
                    { id:'bullet', url:'Image/Projectiles/Random_Projectile2_Rotated.png'},
                    { id:'joypad', url:'Image/Interface/Outer_Square.png'},
                    { id:'joystick',url:'Image/Interface/Inner_Square50px.png'},
                    { id:'hero', url:'Image/Units/Human.png'},
                    { id:'back1', url:'Image/Background/Tiled_Background.png'}
                ],
                function( count, images ) {
                    if (count === images.length) {
                        __start(images);
                    }
                }
            );
        }

        function __start(images) {
            var director = new CAAT.Director().
                    initialize( 800,500, document.getElementById('experiment-canvas') ).
                    setClear( CAAT.Director.CLEAR_DIRTY_RECTS );

            CAAT.currentDirector = director;
            CAAT.PMR = director.width / 10;
            // Preload audio and images!
            director.
                addAudio("audio_1", document.getElementById('audio_1')).
                addAudio("audio_2", document.getElementById('audio_2')).
                addAudio("audio_3", document.getElementById('audio_3')).
                addAudio("music_1", document.getElementById('music_1'));

            director.setImagesCache(images);

            PowerUp.prototype.bomb = director.getImage('bomb');
            PowerUp.prototype.mushroom = director.getImage('mushroom');
            Bullet.prototype.image = director.getImage('bullet');
            Player.prototype.image = director.getImage('hero');
            joystick.setBackgroundImage(director.getImage('joypad'));
            subjs.setBackgroundImage(director.getImage('joystick'));
            // Create Scene
            var scene = director.createScene();
            scene.setBounds(0,0,800,500);
            scene.setFillStyle('#000');
           // scene.setBackgroundImage(director.getImage('back1'));
            scene.cacheAsBitmap();
            world = new Box2D.Dynamics.b2World(new Box2D.Common.Math.b2Vec2(0,0), true);
            world.SetContinuousPhysics(true);

            __createLevel( director, scene );
            //__createHero( scene ,director.getImage('hero'));
            hero =new Player(scene.width/2,scene.height/2).createBody(world);
            scene.addChild(hero);
            __startLevel(director, scene, 1);
            joystickE ? scene.addChild(joystick) : null;
            __setKeys( scene, hero );


            var listener = new Box2D.Dynamics.b2ContactListener;
            listener.BeginContact = function(contact){

            }
            listener.EndContact = function(contact){
                console.log("end");
                var a = contact.GetFixtureA().GetBody();
                var b  = contact.GetFixtureB().GetBody();
                a.SetAngularVelocity(0);
                b.SetAngularVelocity(0);

            }
            world.SetContactListener(listener);


            /* Game Loop */
            scene.onRenderStart= function() {
                world.Step(1.0/60, 1,1);
                world.ClearForces();
                };

            scene.onRenderEnd =  function(time)    {
                world.DrawDebugData();

                if(enemyContainer.childrenList.length==0 && !levelpause){
                    console.log("Level: " +level);
                    __nextLevel(this,level);
                    level++;
                    levelpause = true;
                }else{
                    for(var i=0;i<enemyContainer.childrenList.length;i++){
                        enemyContainer.childrenList[i].move();
                    levelpause = false;
                    }
                }
            }


            CAAT.loop(60);
        }

        function __setKeys( scene, selected ) {
            /**
             * This timer makes the process to increment actor position based on elapsed time.
             * it will move pixelsPerSecond pixels on any direction.
             */
            scene.createTimer( scene.time, Number.MAX_VALUE, null,
                function(time, ttime, timerTask) {

                    var ottime= ttime;
                    if ( -1!=prevTime ) {
                        ttime-= prevTime;

                                var nx= selected.x + joystick.joy_x*(ttime/1100)*10;
                                var ny= selected.y + joystick.joy_y*(ttime/1100)*10;

                            /**
                             * Test map collision: hero vs map.
                             */

                            var collides = collision.getOverlappingActors(new CAAT.Rectangle().setBounds(nx, ny, selected.width, selected.height));

                            if (!collides.length) {
                                selected.setLocation( nx, ny );
                            } else {

                                // Allow frictionless surface when collision with wall.
                                if (wallThickness >= ny || ny + selected.height >= scene.height-wallThickness) {
                                    // Top & Bottom
                                    if (!(nx < wallThickness) && !(nx + selected.width > scene.width - wallThickness)) {
                                        selected.setLocation( nx, selected.y );
                                    }
                                } else if (wallThickness >= nx || nx + selected.width >= scene.width-wallThickness) {
                                    // Left & Right Walls
                                    if (!(ny < wallThickness) && !(ny + selected.height > scene.height - wallThickness)) {
                                        selected.setLocation( selected.x, ny );
                                    }
                                }
                            }
                    }
                    prevTime = ottime;
                },
                null
            );

        }



        function addPowerUp(director, scene, item) {
            var obj;

            for (var i = 0; i < 2; i++) {
                obj = new PowerUp(i);

                powerup.push(obj);
                powerUpContainer.addChild(obj);
            }
        }

        function addEnemies(container,scene,level){
            for(var i=0;i<1*level;i++){
                // var t = new Bullet(0,Math.random()*500).createBody(world);s
                var x, y;
                if(Math.random()>0.5){
                y = Math.random()>0.5? 1: scene.height-100;
                x = Math.random()*scene.width;
                }else{
                x = Math.random()>0.5? 1: scene.width-100;
                y = Math.random()*scene.height;
                }

                var t = new Knight(x, y).createBody(world);

                enemy.push(t);


                window.t = t;
                enemyContainer.addChild(t);
                //Set the direction of the bullets here
                //To use physical formulas use t.worldBody then you can use ApplyForce or ApplyImpulse

                t.setVelocity(hero.x-x,hero.y-y,2);
                window.t=t;
                t.addListener({
                    actorLifeCycleEvent : function(actor, event, time) {
                        if (event === 'expired') {
                            var body = actor.worldBody;
                            world.DestroyBody(body);
                            actor.destroy();
                            enemy.removeByValue(actor);
                        }
                    }
                });
                t.setFrameTime( scene.time, 2000 );
            }
        }

        function __generateLevel() {
            var parseLevel,
                parseEnemy,
                levelJSONLength = levelJSON.length;

            // use level in JSON or modulus of json length.
            // levelJSON[level] ? parseLevel = levelJSON[level]  : levelJSON[level%levelJSONLength];
            parseLevel = levelJSON[level%levelJSONLength];

            console.log(parseLevel.enemy);

            // calculate interpolation
            for (var o=0; o < parseLevel.enemy.length;o++) {
                parseEnemy = parseLevel.enemy[o];
                for (obj in parseEnemy) {
                    console.log(obj + " " + parseEnemy[obj]);
                }
            }

            // generate spawn times
            console.log("spawn");
        }

        function __nextLevel(scene,level){
            scene.createTimer(scene.time+3000,1,function(time,ttime,timerTask){
                // empty array
                enemy.length = 0;
                powerup.length = 0;

                __generateLevel();

                // spawn enemies
                addEnemies(enemyContainer,scene,level);
                this.cancel();
            }, null, null);

        }

        function __startLevel(director, scene, level) {

            var temp;

            var getRand = function () {
                return Math.floor((Math.random()*10)+1);
            }
            window.w = director;
            director.endSound();
            // director.audioLoop("music_1");

            // Create container for holding enemies
            enemyContainer = new CAAT.ActorContainer().setBounds(0, 0, scene.width, scene.height);
            powerUpContainer = new CAAT.ActorContainer().setBounds(0, 0, scene.width, scene.height);

            // Randomly generate enemies based on level, addChild to container
            addEnemies(enemyContainer,scene,level);
            addPowerUp(director, scene);

            // add container to scene
            scene.addChild(enemyContainer,1);
            scene.addChild(powerUpContainer);


            // collision detectiob, enemy
            scene.createTimer( scene.time, Number.MAX_VALUE, null,
                function(time, ttime, timerTask) {
                    var entitiesCollision = new CAAT.QuadTree().create( 0,0, scene.width, scene.height, enemy );
                    var collide = entitiesCollision.getOverlappingActors( new CAAT.Rectangle().setBounds( hero.x, hero.y, hero.width, hero.height) );
                    // console.log(collide);
                    for(var i = 0;i<enemyContainer.length;i++){
                        // enemyContainer[i].setVelocity(0,0);
                    }
                    if ( collide.length ) {
                        // collision with enemies.
                        director.audioPlay("audio_1");
                        if (!hero.die()){
                            console.log('Game Over!');
                        }else{
                            console.log('You have '+hero.lives+' lives remaining');
                        }
                        // enemyContainer.destroy();
                    }
                },
            null);

            // collision detection, power ups
            scene.createTimer( scene.time, Number.MAX_VALUE, null,
                function(time, ttime, timerTask) {
                    var entitiesCollision = new CAAT.QuadTree().create( 0,0, scene.width, scene.height, powerup );
                    var collide = entitiesCollision.getOverlappingActors( new CAAT.Rectangle().setBounds( hero.x, hero.y, hero.width, hero.height) );
                    collide.length ? console.log(collide) : null;
                    // for(var i = 0;i<powerUpContainer.length;i++){
                    //     powerUpContainer[i].setVelocity(0,0);
                    //     console.log(powerUpContainer[i]);
                    // }
                    if ( collide.length ) {
                        // collision with power ups.
                        director.audioPlay("audio_2");
                        console.log("powerup!");
                        console.log(collide[0].pickup());
                    }
                },
            null);
        }


        function __createLevel( director, scene ) {

            // var dx0=                0;
            // var dy0=                0;
            // var dx1=                director.width;
            // var dy1=                director.height;

            // var i;

            // var bounds=[
            //     dx0,dy0,
            //     dx1,dy0,
            //     dx1,dy1,
            //     dx0,dy1,
            //     dx0,dy0
            // ];

            // for( i=0; i<4; i++ ) {
            //     var actor0 = new CAAT.B2DPolygonBody().createBody(
            //         world,
            //         {
            //             bodyType:   Box2D.Dynamics.b2Body.b2_staticBody,
            //             density:    1.2,
            //             friction:   1,
            //             restitution:1,
            //             polygonType:CAAT.B2DPolygonBody.Type.EDGE,
            //             bodyDef:    [
            //                 {x: bounds[i*2  ],  y: bounds[i*2+1] },
            //                 {x: bounds[i*2+2],  y: bounds[i*2+3] }
            //             ],
            //             userData:   {}
            //         }
            //     );
            //     scene.addChild(actor0);
            // }

            var walls = [];

            walls.push({ AABB: new CAAT.Rectangle().setBounds(0, 0, director.width, wallThickness) }); // top
            walls.push({ AABB: new CAAT.Rectangle().setBounds(0, 0, wallThickness, director.height) }); // left
            walls.push({ AABB: new CAAT.Rectangle().setBounds(director.width - wallThickness, 0, wallThickness, director.height) }); // right
            walls.push({ AABB: new CAAT.Rectangle().setBounds(0, director.height - wallThickness, director.width, wallThickness) }); // bottom

            collision = new CAAT.QuadTree().create(0, 0, director.width, director.height, walls);
        }

        var createBall = function(world,x,y,data) {
                return new CAAT.B2DCircularBody().enableEvents(false).createBody(
                    world,
                    {
                        x:                      x,
                        y:                      y,
                        bodyType:               Box2D.Dynamics.b2Body.b2_dynamicBody,
                        radius:                 data.radius,
                        density:                data.density,
                        restitution:            data.restitution,
                        friction:               data.friction,
                        bodyDefScaleTolerance:  data.tolerance,
                        userData:               null
                    });
        }
    })();
</script>