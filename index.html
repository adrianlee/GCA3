<script type="text/javascript" src="lib/caat.js"></script>
<script type="text/javascript" src="main.js"></script>
<script type="text/javascript" src="player.js"></script>

<script type="text/javascript" src="lib/box2d.js"></script>
<script type="text/javascript" src="lib/caat-box2d.js"></script>
<script type="text/javascript" src="enemies.js"></script>

<div class="sample" id="div_canvas"></div>

<style type="text/css">
    body {
        background: #333;
    }
</style>

<div id="experiment-holder">
    <canvas id="experiment-canvas"></canvas>
</div>

<!-- Preload audio assets into DOM -->
<audio src='sound/1.mp3' preload='auto' id='audio_1'></audio>
<audio src='sound/2.mp3' preload='auto' id='audio_2'></audio>
<audio src='sound/3.mp3' preload='auto' id='audio_3'></audio>
<audio src='sound/music.mp3' preload='auto' id='music_1'></audio>

<script>
    (function() {
        CAAT.DEBUG = 1;

        window.addEventListener('load', __start, false);

        var keys = [0,0,0,0];
        var prevTime = -1;
        var pixelsPerSecond = 400;
        var collision = null;
        var entitiesCollision = null;
        var hero = null;
        var world;
        var wallThickness = 5;

        var joystick = true;

        if (joystick) {
            var joystick = new CAAT.ActorContainer().
                setBounds(30,30,100,100).
                setFillStyle('#00ffff');

            var subjs = new CAAT.Actor().
                setBounds(40,40,20,20).
                setFillStyle('#ffff00')

            joystick.addChild(subjs);

            joystick.mouseMove = function(e){
                var child = this.childrenList[0];
                    child.setLocation(
                        e.point.x - child.width/2,
                        e.point.y - child.height/2
                    );
                    this.joy_x = e.point.x - this.width/2;
                    this.joy_y = e.point.y - this.height/2;
                    console.log("drag");
                };
            joystick.mouseExit = function(e){

                if((e.point.x<0 || e.point.x>100) ||(e.point.y<0 ||e.point.y>100) ){
                    console.log(e.point);
                this.joy_x = 0;
                this.joy_y = 0;
                var child = this.childrenList[0];
                child.setLocation(this.width/2-child.width/2,this.height/2-child.height/2);
                }
            }
        }


        function __start() {

            var director = new CAAT.Director().
                    initialize( 800,500, document.getElementById('experiment-canvas') ).
                    setClear( CAAT.Director.CLEAR_DIRTY_RECTS );

            CAAT.currentDirector = director;

            director.
                addAudio("audio_1", document.getElementById('audio_1')).
                addAudio("audio_2", document.getElementById('audio_2')).
                addAudio("audio_3", document.getElementById('audio_3')).
                addAudio("music_1", document.getElementById('music_1'));

            var scene = director.createScene();
            world = new Box2D.Dynamics.b2World(new Box2D.Common.Math.b2Vec2(0,0), true);
            world.SetContinuousPhysics(true);

            scene.setFillStyle( '#000' );
             scene.onRenderStart= function() {
                    world.Step(1.0/60, 1,1);
                    world.ClearForces();
                };

            scene.onRenderEnd =  function()    {
                world.DrawDebugData();
            }
            __createLevel( director, scene );
            __createHero( scene );
            // __createEnemies( director, scene );
            // __createBehaviours( director, scene );
            __startLevel(director, scene, 1);
            joystick ? scene.addChild(joystick) : null;
            __setKeys( scene, hero );


            // __createEnemies( director, scene );
                var dx0=                0;
                var dy0=                0;
                var dx1=                director.width;
                var dy1=                director.height;

                var i;

                var bounds=[
                        dx0,dy0,
                        dx1,dy0,
                        dx1,dy1,
                        dx0,dy1,
                        dx0,dy0
                    ];
            for( i=0; i<4; i++ )    {
                var actor0= new CAAT.B2DPolygonBody().createBody(
                    world,
                    {
                        bodyType:   Box2D.Dynamics.b2Body.b2_staticBody,
                        density:    1.2,
                        friction:   1,
                        restitution:1,
                        polygonType:CAAT.B2DPolygonBody.Type.EDGE,
                        bodyDef:    [
                            {x: bounds[i*2  ],  y: bounds[i*2+1] },
                            {x: bounds[i*2+2],  y: bounds[i*2+3] }
                        ],
                        userData:   {}
                    });
                    scene.addChild(actor0);
                }



            // var b = new Bullet(200,60);
            // scene.addChild(b.createBody(world,b.params));

            window.scene = scene;

            CAAT.loop(60);
        }

        function __setKeys( scene, selected ) {
            /**
             * This timer makes the process to increment actor position based on elapsed time.
             * it will move pixelsPerSecond pixels on any direction.
             */
            scene.createTimer( scene.time, Number.MAX_VALUE, null,
                function(time, ttime, timerTask) {

                    var ottime= ttime;
                    if ( -1!=prevTime ) {
                        ttime-= prevTime;

                        var xinc= (keys[1]-keys[0]);
                        var yinc= (keys[3]-keys[2]);

                            if (joystick) {
                                var nx= selected.x + joystick.joy_x*(ttime/1100)*10;
                                var ny= selected.y + joystick.joy_y*(ttime/1100)*10;
                            } else {
                                var nx= selected.x + (ttime/1000)*pixelsPerSecond * xinc;
                                var ny= selected.y + (ttime/1000)*pixelsPerSecond * yinc;
                            }

                            /**
                             * Test map collision: hero vs map.
                             */

                            var collides = collision.getOverlappingActors(new CAAT.Rectangle().setBounds(nx, ny, selected.width, selected.height));

                            if (!collides.length) {
                                selected.setLocation( nx, ny );
                            } else {
                                console.log("collision");
                                // Allow frictionless surface when collision with wall.
                                if (wallThickness >= ny || ny + selected.height >= scene.height-wallThickness) {
                                    // Top & Bottom
                                    if (!(nx < wallThickness) && !(nx + selected.width > scene.width - wallThickness)) {
                                        selected.setLocation( nx, selected.y );
                                    }
                                } else if (wallThickness >= nx || nx + selected.width >= scene.width-wallThickness) {
                                    // Left & Right Walls
                                    if (!(ny < wallThickness) && !(ny + selected.height > scene.height - wallThickness)) {
                                        selected.setLocation( selected.x, ny );
                                    }
                                }
                            }
                    }
                    prevTime = ottime;
                },
                null
            );


            /**
             * Register a CAAT key listener function
             */
            CAAT.registerKeyListener( function kl( keyEvent ) {

                if ( keyEvent.getKeyCode()===CAAT.Keys.UP ) {
                    keyEvent.preventDefault();
                    keys[2]= ( keyEvent.getAction()==='up' ) ? 0 : 1;
                }
                if ( keyEvent.getKeyCode()===CAAT.Keys.DOWN ) {
                    keyEvent.preventDefault();
                    keys[3]= ( keyEvent.getAction()==='up' ) ? 0 : 1;
                }
                if ( keyEvent.getKeyCode()===CAAT.Keys.LEFT ) {
                    keyEvent.preventDefault();
                    keys[0]= ( keyEvent.getAction()==='up' ) ? 0 : 1;

                    // rotate actor if image
                    if ( keys[0] ^ keys[1] ) {
                            selected.setImageTransformation( keys[0] ? CAAT.SpriteImage.prototype.TR_FLIP_HORIZONTAL : CAAT.SpriteImage.prototype.TR_NONE );
                    }
                }
                if ( keyEvent.getKeyCode()===CAAT.Keys.RIGHT ) {
                    keyEvent.preventDefault();
                    keys[1]= ( keyEvent.getAction()==='up' ) ? 0 : 1;

                    // rotate actor if image
                    if ( keys[0] ^ keys[1] ) {
                        selected.setImageTransformation( keys[1] ? CAAT.SpriteImage.prototype.TR_NONE : CAAT.SpriteImage.prototype.TR_FLIP_HORIZONTAL );
                    }
                }

            });
        }

        function __createEnemies( director, scene ) {
            var NUM_ENEMIES = 4;
            var x,y;

            var lerp= [
                new CAAT.Interpolator().createBounceOutInterpolator(false),
                new CAAT.Interpolator().createExponentialInInterpolator(3,true)
            ];

            var enemies= [];

            for( var i=0; i<NUM_ENEMIES; i++ ) {

                /**
                 * create vertically moving enemies.
                 */
                x= 50 + (director.width-100)/NUM_ENEMIES * i;
                var enemy=
                    new CAAT.Actor().
                        setFillStyle( '#bb0' ).
                        setBounds(x,0,7,21).
                        addBehavior(
                            new CAAT.PathBehavior().
                                    setValues(
                                        new CAAT.Path().
                                                setLinear( x, 20, x, director.h,40)
                                    ).
                                    setPingPong().
                                    setFrameTime( 0, 2000 + i*250 ).
                                    setCycle( true ).
                                    setInterpolator( lerp[i%lerp.length] )
                        );

                scene.addChild(enemy);
                enemies.push( enemy );

                /**
                 * create horizontally moving elemies.
                 */
                y= 50 + (director.height-100)/NUM_ENEMIES * i;
                enemy=
                    new CAAT.Actor().
                        setFillStyle( '#bb0' ).
                        setBounds(x,0,21,7).
                        addBehavior(
                            new CAAT.PathBehavior().
                                    setValues(
                                        new CAAT.Path().
                                                setLinear( 50, y, director.width-50, y )
                                    ).
                                    setPingPong().
                                    setFrameTime( 0, 6000 + i*250 ).
                                    setCycle( true ).
                                    setInterpolator( lerp[i%lerp.length] )
                        );
                scene.addChild(enemy);
                enemies.push( enemy );
            }

            /**
             * Check on every frame, whether our hero collides with any enemy.
             */
            scene.createTimer( scene.time, Number.MAX_VALUE, null,
                function(time, ttime, timerTask) {

                    entitiesCollision = new CAAT.QuadTree().create( 0,0, director.width, director.height, enemies );

                    var collide= entitiesCollision.getOverlappingActors( new CAAT.Rectangle().setBounds( hero.x, hero.y, hero.width, hero.height) );
                    if ( collide.length ) {
                        // collision with enemies.
                        hero.setLocation( 112, 112 );
                    }


                },
                null);
        }

        function __createHero( scene ) {
            var size= 25;

            hero = new CAAT.B2DPolygonBody().createBody(world,{
                    bodyType:   Box2D.Dynamics.b2Body.b2_staticBody,
                    x: scene.width/2,
                    y: scene.height/2,
                    density:    1.2,
                    friction:   1,
                    restitution: 0.5,
                    polygonType:CAAT.B2DPolygonBody.Type.BOX,
                    bodyDef:    [
                        {x: 0,  y: 0 },
                        {x: 10,  y: 10 }
                    ],
                    userData:   {}

            });
            hero.setFillStyle('#fff');
            hero.cacheAsBitmap();
            scene.addChild( hero );
        }

        function __startLevel(director, scene, level) {
            var enemyContainer;
            var enemy = [];
            var temp;

            var getRand = function () {
                return Math.floor((Math.random()*10)+1);
            }

            director.endSound();
            // director.audioLoop("music_1");

            // Create container for holding enemies
            enemyContainer = new CAAT.ActorContainer().setBounds(0, 0, scene.width, scene.height);

            // Randomly generate enemies based on level, addChild to container
            for(var i=0;i<1*level;i++){
                var t = new Bullet(0,Math.random()*500);
                enemyContainer.addChild(t.createBody(world,t.params));
                enemy.push(t);
                //Set the direction of the bullets here
                //To use physical formulas use t.worldBody then you can use ApplyForce or ApplyImpulse
                t.setVelocity(5+Math.random()*3,2+Math.random()*3);
                t.addListener({
                    actorLifeCycleEvent : function(actor, event, time) {
                        if (event === 'expired') {
                            var body = actor.worldBody;
                            world.DestroyBody(body);
                        }
                    }
                });
                t.setFrameTime( scene.time, 7500 );


            }
            // add container to scene
            scene.addChild(enemyContainer,1);

            // collision detection
            scene.createTimer( scene.time, Number.MAX_VALUE, null,
                function(time, ttime, timerTask) {
                    entitiesCollision = new CAAT.QuadTree().create( 0,0, scene.width, scene.height, enemy );
                    var collide = entitiesCollision.getOverlappingActors( new CAAT.Rectangle().setBounds( hero.x, hero.y, hero.width, hero.height) );
                    for(var i = 0;i<enemyContainer.length;i++){
                        enemyContainer[i].setVelocity(0,0);
                    }
                    if ( collide.length ) {
                        // collision with enemies.
                        director.audioPlay("audio_1");
                        hero.setLocation( scene.width/2-hero.width/2, scene.height/2-hero.height/2 );
                        // enemyContainer.destroy();
                    }
                },
                null);
        }


        function __createLevel( director, scene ) {
            var walls = [];

            walls.push({ AABB: new CAAT.Rectangle().setBounds(0, 0, director.width, wallThickness) }); // top
            walls.push({ AABB: new CAAT.Rectangle().setBounds(0, 0, wallThickness, director.height) }); // left
            walls.push({ AABB: new CAAT.Rectangle().setBounds(director.width - wallThickness, 0, wallThickness, director.height) }); // right
            walls.push({ AABB: new CAAT.Rectangle().setBounds(0, director.height - wallThickness, director.width, wallThickness) }); // bottom

            collision = new CAAT.QuadTree().create(0, 0, director.width, director.height, walls);
        }

        var createBall = function(world,x,y,data) {
                return new CAAT.B2DCircularBody().enableEvents(false).createBody(
                    world,
                    {
                        x:                      x,
                        y:                      y,
                        bodyType:               Box2D.Dynamics.b2Body.b2_dynamicBody,
                        radius:                 data.radius,
                        density:                data.density,
                        restitution:            data.restitution,
                        friction:               data.friction,
                        bodyDefScaleTolerance:  data.tolerance,
                        userData:               null
                    });
        }
    })();
</script>